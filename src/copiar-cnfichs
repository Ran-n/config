#! /bin/sh
#+ Autor:	Ran#
#+ Creado:	22/04/2020 00:23:18
#+ Editado:	2022/09/06 22:05:26.581781

#* Script que copia of ficheiros de configuración da máquina na que estou

crear_carpeta () {
    if [[ ! -d $(pwd)/$CNFOLDER/$1 ]]; then
        [[ $VERBOSE -eq 1 ]] && mkdir -vp $(pwd)/$CNFOLDER/$1 || mkdir -p $(pwd)/$CNFOLDER/$1
        #chown $(pwd)/$CNFOLDER/$1
    fi
}

copiar_elemento () {
    # carpetas
    if [[ $elemento == */ ]]; then
        if [[ ! -d $(pwd)/$CNFOLDER/$1$ruta ]]; then
            [[ $VERBOSE -eq 1 ]] && mkdir -vp $(pwd)/$CNFOLDER/$1$ruta || mkdir -p $(pwd)/$CNFOLDER/$1$ruta
        fi
        [[ $VERBOSE -eq 1 ]] && cp -vupfr $elemento. $(pwd)/$CNFOLDER/$1$ruta || cp -upfr $elemento. $(pwd)/$CNFOLDER/$1$ruta
    # ficheiros
    else
        if [[ ! -d $(pwd)/$CNFOLDER/$1$(dirname $ruta) ]]; then
            [[ $VERBOSE -eq 1 ]] && mkdir -vp $(pwd)/$CNFOLDER/$1$(dirname $ruta) || mkdir -p $(pwd)/$CNFOLDER/$1$(dirname $ruta)
        fi
        [[ $VERBOSE -eq 1 ]] && cp -vupfr $elemento $(pwd)/$CNFOLDER/$1$ruta || cp -upfr $elemento $(pwd)/$CNFOLDER/$1$ruta
    fi
}

eliminar () {
    find "$1" -name "$2" -exec rm -rf {} +
}

# mirar se o script se executa como root
# de non, facer que así sexa
if [[ $(/usr/bin/id -u) != 0 ]]; then
    if whereis sudo &>/dev/null; then
        # correr o script de novo como sudo e cos parametros dados
        sudo $0 $*
        # para que non se execute dúas veces
        exit 0
    else
        # saída con erro
        exit 1
    fi
fi

FICH=$(pwd)"/media/arquivos.csv"
ACCEPT_ENCRIPT=1

LINGUA=$(grep -w "lang" $(pwd)/.cnf | cut -d= -f2)
VERBOSE=$(grep -w "verbose" $(pwd)/.cnf | cut -d= -f2)
CONTRASINAL=$(grep -w "passwd" $(pwd)/.cnf | cut -d= -f2)
CNFOLDER=$(grep -w "cnfolder" $(pwd)/.cnf | cut -d= -f2)
CNFOLDER_HOME=$(grep -w "cnfolder_home" $(pwd)/.cnf | cut -d= -f2)
CNFOLDER_ROOT=$(grep -w "cnfolder_root" $(pwd)/.cnf | cut -d= -f2)

FOGAR=$(eval echo "~$(who -m | awk '{ print $1 }')")

case $LINGUA in
    gz)
        echo "► Copiando os ficheiros de configuración"
        ;;
    en)
        echo "► Copying the configuration files"
        ;;
    cas)
        echo "► Copiando los ficheros de configuración"
        ;;
esac

while read line; do
    # ignorar liñas comentadas ou baleiras
    if [[ $line != \#* && -n $line ]]; then
        encriptar=$(echo $line | cut -d, -f1)
        ruta=$(echo $line | cut -d, -f2)
        excluir=$(echo $line | cut -d, -f3)

        if [[ $ruta = \~* ]]; then
            ruta=$(echo $ruta | cut -d~ -f2)
            elemento=$FOGAR$ruta

            copiar_elemento $CNFOLDER_HOME $excluir

            [[ -n $excluir ]] && eliminar $(pwd)/$CNFOLDER/$CNFOLDER_HOME$ruta $excluir

            if [[ $encriptar -eq $ACCEPT_ENCRIPT ]]; then
                7z a $(pwd)/$CNFOLDER/$CNFOLDER_HOME$ruta $(pwd)/$CNFOLDER/$CNFOLDER_HOME$ruta -p$CONTRASINAL -mhe=on 2&>/dev/null
            fi
        else
            elemento=$ruta

            copiar_elemento $CNFOLDER_ROOT $excluir

            [[ -n $excluir ]] && eliminar $(pwd)/$CNFOLDER/$CNFOLDER_ROOT$ruta $excluir
        fi


    fi
done < $FICH

# preciso cambiar isto porque se executa como root e quedaría como owner
user=$(who -m | cut -d\  -f1)
chown -R $user:$user $(pwd)/$CNFOLDER

case $LINGUA in
    gz)
        echo "◄ BO"
        ;;
    en)
        echo "► OK"
        ;;
    cas)
        echo "► OK"
        ;;
esac
